<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root { --bg: #111; --stage: #fff; }
html, body { margin: 0; height: 100%; background: var(--bg); font-family: system-ui, sans-serif; }
.wrap { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }

.stage {
  width: min(80vmin, 720px);
  height: min(80vmin, 720px);
  background: var(--stage);
  border-radius: 8px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  position: relative;
  overflow: hidden;
}

#march {
  position: absolute;
  width: 100px;
  height: 100px;
  left: 0;
  top: 0;
  transform-origin: center bottom;
  pointer-events: none;
}

#joystick {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
  z-index: 10;
}
#joystick .stick {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: white;
  transform: translate(0,0);
  margin: 20px;
}
@media (hover:hover) and (pointer:fine){ #joystick { display:none; } }

/* Particle canvas on top but ignore pointer events */
#particle-canvas {
  position: absolute;
  pointer-events: none;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 5;
}
</style>
</head>
<body>
<div class="wrap">
  <div id="stage" class="stage">
    <canvas id="particle-canvas"></canvas>
    <img id="march" src="https://i.postimg.cc/0r1jycP7/March.png" draggable="false">
  </div>
  <div id="joystick"><div class="stick" id="stick"></div></div>
</div>

<script>
const stage = document.getElementById('stage');
const march = document.getElementById('march');
const joystick = document.getElementById('joystick');
const stick = document.getElementById('stick');
const canvas = document.getElementById('particle-canvas');
const ctx = canvas.getContext('2d');

// Audio: quack sound
const quack = new Audio('https://freesound.org/data/previews/445/445960_5121236-lq.wav');

let pos = { x: 0, y: 0 };
let vel = { x: 0, y: 0 };
const maxSpeed = 220;
const accel = 1600;
let lastQuack = performance.now();

// Particles
const particles = [];
function emitParticles(x, y){
  for(let i=0;i<10;i++){
    particles.push({x,y,vx:(Math.random()-0.5)*2,vy:(Math.random()-1)*2,life:60+Math.random()*30});
  }
}
function updateParticles(){
  canvas.width = stage.clientWidth;
  canvas.height = stage.clientHeight;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.life--;
    ctx.globalAlpha = p.life/90;
    ctx.fillStyle = 'yellow';
    ctx.beginPath();
    ctx.arc(p.x,p.y,3,0,Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;
    if(p.life<=0) particles.splice(i,1);
  }
}

// joystick
let joyActive=false, joyCenter={x:0,y:0}, joyMax=80, joyVec={x:0,y:0};
function layoutJoystick(){
  const rc = joystick.getBoundingClientRect();
  joyCenter.x = rc.left + rc.width/2;
  joyCenter.y = rc.top + rc.height/2;
  joyMax = Math.min(rc.width, rc.height)/2 - 10;
}
layoutJoystick();
window.addEventListener('resize', layoutJoystick);
function setStick(clientX, clientY){
  const dx=clientX-joyCenter.x, dy=clientY-joyCenter.y;
  const dist=Math.hypot(dx,dy);
  const limited=Math.min(dist,joyMax);
  const nx=dx/(dist||1), ny=dy/(dist||1);
  stick.style.transform=`translate(${nx*limited}px, ${ny*limited}px)`;
  joyVec.x = nx*limited/joyMax;
  joyVec.y = ny*limited/joyMax;
}
joystick.addEventListener('pointerdown',e=>{ joystick.setPointerCapture(e.pointerId); joyActive=true; layoutJoystick(); setStick(e.clientX,e.clientY); });
joystick.addEventListener('pointermove',e=>{ if(!joyActive) return; setStick(e.clientX,e.clientY); });
joystick.addEventListener('pointerup',e=>{ joystick.releasePointerCapture(e.pointerId); joyActive=false; stick.style.transform='translate(0,0)'; joyVec={x:0,y:0}; });

// keyboard
const keys = { w:false, a:false, s:false, d:false };
window.addEventListener('keydown', e=>{ const k=e.key.toLowerCase(); if(['w','a','s','d'].includes(k)){ keys[k]=true; e.preventDefault(); }});
window.addEventListener('keyup', e=>{ const k=e.key.toLowerCase(); if(['w','a','s','d'].includes(k)){ keys[k]=false; e.preventDefault(); }});

// Apply March position
function applyPos(){ march.style.left = pos.x+'px'; march.style.top = pos.y+'px'; }

function loop(now){
  const dt=Math.min((now-(loop.last||now))/1000,1/30); loop.last=now;

  // Input
  let ix=0, iy=0;
  if(keys.a) ix-=1; if(keys.d) ix+=1;
  if(keys.w) iy-=1; if(keys.s) iy+=1;
  const len=Math.hypot(ix,iy);
  if(len>0){ ix/=len; iy/=len; }
  const inputX = joyActive?joyVec.x:ix;
  const inputY = joyActive?joyVec.y:iy;

  // Velocity smoothing
  const tgtX=inputX*maxSpeed, tgtY=inputY*maxSpeed;
  const dx=tgtX-vel.x, dy=tgtY-vel.y;
  const maxStep=accel*dt;
  vel.x+=Math.sign(dx)*Math.min(Math.abs(dx),maxStep);
  vel.y+=Math.sign(dy)*Math.min(Math.abs(dy),maxStep);

  pos.x+=vel.x*dt; pos.y+=vel.y*dt;

  // Stage bounds
  const r=stage.getBoundingClientRect();
  pos.x=Math.min(Math.max(0,pos.x), r.width - march.offsetWidth);
  pos.y=Math.min(Math.max(0,pos.y), r.height - march.offsetHeight);
  applyPos();

  // Squish animation
  const speed=Math.hypot(vel.x, vel.y);
  const moving = speed>8;
  const t=now/600;
  let sx=1, sy=1;
  if(moving){
    const factor=0.12 + 0.04*Math.sin(t*2);
    sx = 1 + factor*Math.abs(Math.sin(t*1.5));
    sy = 1 - factor*Math.abs(Math.cos(t*1.5));
  }
  const bob = moving?Math.sin(t*1.5)*4:0;
  const facing = vel.x<-6?-1:(vel.x>6?1:(march._facing||1));
  march._facing = facing;
  march.style.transform = `translate(${-march.offsetWidth/2}px, ${-march.offsetHeight*0.28+bob}px) scaleX(${facing*sx}) scaleY(${sy})`;

  // Quack every 8 sec
  if(now-lastQuack>8000){
    quack.currentTime=0; quack.play(); lastQuack=now;
    const mr= march.getBoundingClientRect();
    emitParticles(mr.left+mr.width/2 - r.left, mr.top+mr.height/2 - r.top);
  }

  updateParticles();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

window.addEventListener('resize',()=>{ canvas.width=stage.clientWidth; canvas.height=stage.clientHeight; });

window.onload = ()=>{
  const r=stage.getBoundingClientRect();
  pos.x=(r.width-march.offsetWidth)/2; pos.y=(r.height-march.offsetHeight)/2;
  applyPos(); canvas.width=r.width; canvas.height=r.height; layoutJoystick();
}

window.addEventListener('touchmove', e=>{ if(joyActive) e.preventDefault(); }, {passive:false});
</script>
</body>
</html>